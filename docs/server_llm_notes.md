Server & LLM Notes

- server.js
  - Bootstraps config (default + override yaml + --port), sets Globals.baseDir/config, and initializes Express + HTTP + RealtimeHub + ModLoader static serving. Maintains in-memory maps for players, things, skills, locations, exits, regions, pending stubs/images, and in-flight generations. Provides chat utilities (`normalizeChatEntry`, `pushChatEntry`, `scrubGeneratedBrackets`), location/region/thing helpers, save/load wiring (exposed via module.exports), and exposes many of these via `apiScope`.
  - Builds `promptEnv`/`viewsEnv` with Nunjucks, loads templates, and defines `prepareBasePromptContext` (builds base prompt context, triggers NPC memory selection jobs). Attaches `Globals.getBasePromptContext` and other helpers (e.g., plausibility parsing, attack resolution, status ticking).
  - Recent history keeps `event-summary` entries intact (scrubber can skip event stripping via `scrub_events`); if their content is empty, `<recentStoryHistory>` renders them from `summaryItems` and strips any event-summary lines containing ðŸ§ª. Absent-character suffixes union `locationId` and `metadata.traveledToLocationId` when present.
  - Base prompt context can omit craft/harvest/process history entries when requested (used by crafting/harvest prompts to reduce duplicate actions).
  - Base prompt context now includes NPC representation summaries (`npcRepresentation`) with race/class counts across all tracked NPCs, and NPC generation prompts include shared guidance to keep race/class variety reasonable without breaking story coherence.
  - NPC generation prompts now include a shared contemplation/self-correction step sequence (free-text steps followed by final XML output) to improve NPC planning quality before parsing.
  - Base prompt context now includes a `<factions>` block for LLM generation; location/region generators and NPC generators expect full faction names (or "None") and the server resolves those names to ids.
  - Faction generation now tolerates incomplete output: missing/invalid relation entries are ignored or normalized, unspecified inter-faction relations default to neutral with a default note, and missing faction assets default to an empty list (with warnings) instead of failing new-game setup.
  - NPC progression now uses formula-driven point pools for both skills and attributes (`formulas.character_creation.*`). NPC prompts provide priority lists (not exact numbers), and the server spends pool deltas in one pass, including multi-level gains from a single level-up event. Creation and level-up flows log computed attribute/skill budgets for debugging.
- Manages image generation backends (ComfyUI/NanoGPT/OpenAI), queuing (`createImageJob`, `processJobQueue`, job maps/sets, `generateImageId`), and exposes job snapshots. ComfyUI initialization logs a warning and continues if the server is unavailable while keeping the client enabled for later startup. Handles realtime attach, slash commands, mod loading, and kicks off default player creation + server start.
  - Initializes `Events` with dependencies (Location/Region accessors, generation functions, exit connection helpers, image generators, quest confirmation, etc.) and then registers routes via api.js using the populated `apiScope`.

- api.js
  - Exports `registerApiRoutes(scope)`; validates scope (must include Express app plus numerous helpers) and optionally installs an axios AI debug interceptor. Uses `with (scope)` to share state. Utility helpers inside include stream emitters for realtime (`realtimeHub`), autosave pruning, XML helpers for crafting/random events, and deletion helpers for NPCs/things.
- New-game/load lifecycle also includes calendar generation support: `/api/new-game` requests an LLM-generated calendar definition using setting context (`calendar_generation` metadata label), and the prompt explicitly requires Gregorian output when the setting is reasonably Earth-based while also requesting season descriptions, seasonal `timeDescriptions`, and 10 holidays (with descriptions). Load regenerates one only when a save is missing `calendarDefinition`; both paths fall back to Gregorian on failure.
- `/api/new-game` also runs a base-context intro prompt (`game_intro`) after world setup and appends a visible `game-intro` assistant entry before the first player turn; failures are logged and do not fail new-game creation.
- `api.js` exposes `Globals.generateGameIntro` so slash commands can trigger the same intro prompt on demand.
- `/api/chat` is the main turn handler: applies status effect need deltas, optional travel metadata, autosave (autosaves skip the newest chat entry if it matches the latest autosave entry id), plausibility/attack checks (attack rolls add level bonuses: ceil(attacker/2) to attack skill + damage attribute; floor(defender/2) to evade/deflect), builds prompts via `prepareBasePromptContext` + `promptEnv`, calls `LLMClient.chatCompletion`, logs prompts, and streams status back to the client. It records chat history, injects NPC/location memories, may trigger `Events.runEventChecks`, advances canonical world time from `time_passed` event outputs (internally decimal hours), includes `worldTime` payloads in chat responses/history (including season and holiday descriptions when available), and schedules hidden asynchronous post-turn prompts:
  - Supplemental story info cadence uses `supplemental_story_info_prompt_frequency` (`0` disables, `>0` runs every X turns) plus extra runs on turns where new NPCs/things were generated.
  - Offscreen NPC activity runs on world-time crossings at 07:00/19:00 (daily count from `offscreen_npc_activity_prompt_count`) and weekly at day multiples of 7 at 07:00 (15 NPCs, excluding names already surfaced by daily runs).
  - If elapsed time crosses multiple offscreen checkpoints in one turn, only one offscreen prompt runs.
  - Offscreen activity entries with `moved=true` attempt server-side NPC relocation from the reported region/location fields, updating `currentLocation` and location NPC lists with server-console logging only (no client payload changes).
  - Hidden entries are stored server-side as `[Hidden from Player]` notes.
  - Base-context now appends compact current conditions at the end of the prompt (`time` in 24-hour `HH:MM`, plus `weather` name/description and `lightLevel` description only when the current location supports local weather). Region weather definitions are parsed from region-generation XML and persisted on `Region`.
  - The rest of turn handling still includes attack damage application, quest confirmations, random event seeds, NPC corpse cleanup, and structured debug info.
  - Random events are checked independently of NPC turn processing (forced-event actions still suppress random events), and rolls are scaled by `random_event_frequency_multiplier`.
  - On `<travelProse>` turns, split origin/destination event checks can apply `item_appear` and `scenery_appear` outcomes even after movement has been marked processed.
  - Additional endpoints cover quest confirmations, chat history mutations, player CRUD (attributes, health, needs, party, skills, portraits), NPC CRUD/teleport/equipment/dispositions/memories/goals, location/region CRUD and generation (including stub expansion, exits, maps), crafting, thing/item operations (create, give/drop/teleport/delete/image), settings management (create/save/load/apply), save/load/new-game flows, slash commands, config test endpoints, and image job APIs (request/async generation/job status/metadata listing).
  - Save-load reconciliation now enforces party/location invariants for the current player on load: party members are removed from all location `npcIds` lists and their explicit `currentLocation` is cleared.
  - Uses helpers like `runAutosaveIfEnabled`, `generateRandomEventSeeds/ensureRandomEventSeedsForArea`, `renderCraftOutcomeForDegree`, and numerous validation branches to reject unsupported operations with explicit errors/status codes.

- Events.js
  - Static orchestrator class with `initialize(deps)` to wire dependencies (Location/Region lookup/generation, prompt env, XML parsing, exit connections, image generation, quest confirmations, currency labels, etc.) and configure timeouts/status durations. Maintains tracking sets to dedupe item/NPC/location changes in a turn.
  - `runEventChecks` renders an event-check prompt (built from EVENT_PROMPT_ORDER), calls `LLMClient.chatCompletion` with a required `<final>` regex (so missing blocks retry), parses the numbered answers from the `<final>` block into structured entries, and optionally suppresses environmental effects. It aggregates raw text into HTML, tracks follow-up queues, and can recursively analyze reward prose. Combined group answers are parsed as final block text (no extra `<final>` wrapper).
  - Before applying outcomes, Events ensures referenced NPCs exist (excluding death/incapacitation and defeated-enemy mentions), so handlers can resolve actors reliably; ensured NPCs are title-cased when their source name contains no capital letters.
  - Parsers/aggregators/handlers convert LLM responses into world mutations: new exits/movement, location alterations/regeneration, currency changes, item animation/alter/consume/drop/harvest/appearance, NPC arrival/departure/spawn, party changes, dispositions, status effects, environmental damage/healing, need bar changes, XP and quest awards/completions, deaths/incapacitation, triggered abilities, and random event seeding. Handlers rely on injected helpers to create/locate entities, ensure exits, queue assets, and generate images when needed.
  - Provides quest-specific checks, status effect helpers (`makeStatusEffect`, default/major durations), placeholder item creation for alterations, and utility methods for accessing current player/config/deps through `this._deps`.

- LLMClient.js
  - Axios-based chat wrapper pulling defaults from `Globals.config.ai`; enforces explicit config (endpoint/apiKey/model) and normalizes `/chat/completions` endpoints. Controls concurrency with semaphores keyed by apiKey+model (`getMaxConcurrent`), supports per-call overrides plus prompt_ai_overrides by metadataLabel.
  - Supports streaming with progress tracking/broadcast (`prompt_progress` via `Globals.realtimeHub`), timeout scaling, retry handling with optional waits, and on-response hooks. Seeds requests unless suppressed, resolves temperature/max_tokens, and merges extra payload/headers.
  - Strips `<think>` blocks from responses after optionally logging; validates XML and required tags when requested, writes errors and prompts to `logs/` via `writeLogFile`/`logPrompt`, and dumps debug payloads when enabled. Exposes helpers for base timeout resolution and progress rendering (interactive terminal friendly but guarded by TTY checks).
