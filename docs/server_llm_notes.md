Server & LLM Notes

- server.js
  - Bootstraps config (default + override yaml + --port), sets Globals.baseDir/config, and initializes Express + HTTP + RealtimeHub + ModLoader static serving. Maintains in-memory maps for players, things, skills, locations, exits, regions, pending stubs/images, and in-flight generations. NPC single-generation dedupe now keys only on explicit non-empty names so unnamed Add NPC requests can run concurrently. Provides chat utilities (`normalizeChatEntry`, `pushChatEntry`, `scrubGeneratedBrackets`), location/region/thing helpers, save/load wiring (exposed via module.exports), and exposes many of these via `apiScope`.
  - `pushChatEntry` applies bracket/event/think scrub cleanup only to non-user entries; user message content is preserved as entered.
  - Builds `promptEnv`/`viewsEnv` with Nunjucks, loads templates, and defines `prepareBasePromptContext` (builds base prompt context, triggers NPC memory selection jobs). Attaches `Globals.getBasePromptContext` and other helpers (e.g., plausibility parsing, attack resolution, status ticking).
  - Recent history keeps `event-summary` entries intact (scrubber can skip event stripping via `scrub_events`); if their content is empty, `<recentStoryHistory>` renders them from `summaryItems` and strips any event-summary lines containing ðŸ§ª. Absent-character suffixes union `locationId` and `metadata.traveledToLocationId` when present.
  - When scene summaries are used for older context, hidden entries (`[Hidden from Player]`) and event/status summary-style blocks are skipped from the scene-summary/fallback section so they do not appear inline between summarized scenes.
  - Scene summary parsing accepts `<details>` lines per scene, stores them on `SceneSummaries`, and includes them in older-history scene blocks passed into base-context with compact (single-spaced) bullet rendering. When overlapping legacy/new scene ranges exist, base-context scene selection prefers the most recently ingested scene coverage per entry index.
  - Scene-summary generation input (used by `/summarize` and scene-threshold summarization) excludes event/status summary-style entries while preserving hidden supplemental/offscreen entries.
  - Base prompt context can omit craft/harvest/process history entries when requested (used by crafting/harvest prompts to reduce duplicate actions).
  - Base prompt context now includes NPC representation summaries (`npcRepresentation`) with race/class counts across all tracked NPCs, and NPC generation prompts include shared guidance to keep race/class variety reasonable without breaking story coherence.
  - Base-context `<currentLocation><npcs>` entries now include raw `resistances` and `vulnerabilities` strings so combat/attack prompts can reason about effectiveness from NPC profiles.
  - NPC generation prompts now include a shared contemplation/self-correction step sequence (free-text steps followed by final XML output) to improve NPC planning quality before parsing.
  - NPC XML parsing for location/region/single generation now captures `resistances` and `vulnerabilities`, and those strings are persisted directly on generated `Player` NPC records.
  - NPC generation now includes alias generation (`npc_alias_assignments`) via standard `LLMClient.logPrompt` logging. Alias prompts run alongside ability/inventory generation paths, aliases are persisted on `Player` objects, `ensureNpcByName` resolves in order (full names, party aliases, same-location aliases, global aliases), and k-gram normalization excludes both NPC name and alias tokens.
  - Base prompt context now includes a `<factions>` block for LLM generation; location/region generators and NPC generators expect faction names (or "None"), and server-side resolution now matches case-insensitively with punctuation stripped before mapping names to ids.
  - If a generated faction name still does not match, faction resolution logs a server warning with the unmatched name and falls back to no faction instead of aborting generation.
  - Region-entry stub expansion now applies defensive controlling-faction reconciliation: unknown stub/region faction ids are ignored with warnings, generated faction mismatches do not abort expansion, and existing saved region faction is preferred when conflicts occur.
  - Region-entry finalization now rewires any remaining inbound exits that still target the consumed stub to point at the finalized entrance location (dropping accidental entrance self-loops and rebuilding reverse links for bidirectional exits), removes stale `locationIds` and `entranceLocationId` references to the consumed stub across all regions (repairing non-target region entrances to valid fallbacks when available), then removes the consumed stub from both `gameLocations` and `Location` static indexes, and asserts post-finalization integrity (no remaining region references/exits/player location pointing at the removed stub).
  - Faction generation now runs in three prompts: core factions (`faction_generation`), inter-faction relationships for all factions (`faction_relationship_generation`), then reputation tiers for all factions (`faction_reputation_generation`). Each stage retries up to 3 times on stage failure (render/prompt/LLM/parse/validation errors). Missing/invalid relation entries are ignored or normalized, unspecified inter-faction relations default to neutral with a default note, missing faction assets default to an empty list (with warnings), surplus generated factions beyond `config.factions.count` are accepted (only too-few factions fail new-game setup), and reputation-tier output must include tiers for every generated faction.
  - Prompt templates now also include `prompts/faction-inbound-relationships-generator.xml.njk` for one-pass generation of existing factions' dispositions toward a newly created faction.
  - NPC progression now uses formula-driven point pools for both skills and attributes (`formulas.character_creation.*`). NPC prompts provide priority lists (not exact numbers), and the server spends pool deltas in one pass, including multi-level gains from a single level-up event. Creation and level-up flows log computed attribute/skill budgets for debugging.
  - Player level-up ability assignment is now a player-only draft flow instead of automatic assignment: missing levels are detected from level 1..current level using `player_abilities_per_level`, pending state can be resolved without generation, option pools are generated on explicit ability-selection fetch (`generateOptions=true`) so the modal can open first, generated options are persisted on the `Player` record, and gameplay stays blocked until pending levels are submitted in order.
  - `generateItemsByNames` now accepts generation `options` and only parses as inventory when an owner is provided, so event/location generation can preserve `scenery` outputs (including `treatAsScenery` / `treatAsResource` flows) instead of coercing everything to `item`.
- Manages image generation backends (ComfyUI/NanoGPT/OpenAI), queuing (`createImageJob`, `processJobQueue`, job maps/sets, `generateImageId`), and exposes job snapshots. ComfyUI initialization logs a warning and continues if the server is unavailable while keeping the client enabled for later startup. Handles realtime attach, slash commands, mod loading, and kicks off default player creation + server start.
  - Initializes `Events` with dependencies (Location/Region accessors, generation functions, exit connection helpers, image generators, quest confirmation, etc.) and then registers routes via api.js using the populated `apiScope`.

- api.js
  - Exports `registerApiRoutes(scope)`; validates scope (must include Express app plus numerous helpers) and optionally installs an axios AI debug interceptor. Uses `with (scope)` to share state. Utility helpers inside include stream emitters for realtime (`realtimeHub`), autosave pruning, XML helpers for crafting/random events, and deletion helpers for NPCs/things.
- New-game/load lifecycle also includes calendar generation support: `/api/new-game` requests an LLM-generated calendar definition using setting context (`calendar_generation` metadata label), and the prompt explicitly requires Gregorian output when the setting is reasonably Earth-based while also requesting season descriptions, seasonal `timeDescriptions`, and 10 holidays (with descriptions). Load regenerates one only when a save is missing `calendarDefinition`; both paths fall back to Gregorian on failure.
- `/api/new-game` also runs a base-context intro prompt (`game_intro`) after world setup and appends a visible `game-intro` assistant entry before the first player turn; failures are logged and do not fail new-game creation.
- `api.js` exposes `Globals.generateGameIntro` so slash commands can trigger the same intro prompt on demand.
- Game intro prose now runs through the slop-removal pipeline (`applySlopRemoval`) before the `game-intro` chat entry is stored, and emits a linked `slop-remover` attachment entry when slop checks run.
- `/api/chat` is the main turn handler: applies status effect need deltas, optional travel metadata, autosave (autosaves skip the newest chat entry if it matches the latest autosave entry id), plausibility/attack checks (attack rolls add level bonuses: ceil(attacker/2) to attack skill + damage attribute; floor(defender/2) to evade/deflect), builds prompts via `prepareBasePromptContext` + `promptEnv`, runs a tool-aware `LLMClient.chatCompletion` loop (currently exposing `moreInfo(name)` for template-rendered XML summaries of matching NPCs/things/locations/regions plus `getHistory(query)` for matching assistant prose history entries), logs prompts, and streams status back to the client. Status effects now track `appliedAt` world time and tick per elapsed in-game minute (with finite durations decremented in minute units, capped to remaining duration). It records chat history, injects NPC/location memories, may trigger `Events.runEventChecks`, advances canonical world time from `time_passed` event outputs (parsed as minutes via shared duration parsing), includes `worldTime` payloads in chat responses/history (`timeMinutes`, season, and holiday descriptions when available), and schedules hidden asynchronous post-turn prompts:
  - Supplemental story info cadence uses `supplemental_story_info_prompt_frequency` (`0` disables, `>0` runs every X turns) plus extra runs on turns where new NPCs/things were generated.
  - Plot summary cadence runs every 10 player action submissions (normal/creative actions; excludes question/generic/forced/comment flows) and launches asynchronously (`void` call) so event checks and downstream turn flow are not blocked. Responses are stored as hidden `plot-summary` entries.
  - Plot expander cadence runs every `plot_expander_prompt_frequency` eligible player action submissions (default `10`; `0` disables) and launches asynchronously (`void` call) so event checks and downstream turn flow are not blocked. Responses are stored as hidden `plot-expander` entries.
  - On load, if `metadata.plotSummaryTurnCounter` is missing (older saves), the server initializes it and schedules a one-shot immediate run on the next eligible player action turn.
  - Offscreen NPC activity runs on world-time crossings at 07:00/19:00 (daily count from `offscreen_npc_activity_prompt_count`) and weekly at day multiples of 7 at 07:00 (15 NPCs, excluding names already surfaced by daily runs). Scheduling comparisons and state snapshots are minute-based (`{ dayIndex, timeMinutes }`).
  - If elapsed time crosses multiple offscreen checkpoints in one turn, only one offscreen prompt runs.
  - Offscreen activity entries with `moved=true` attempt server-side NPC relocation from the reported region/location fields, updating `currentLocation` and location NPC lists with server-console logging only (no client payload changes).
  - Hidden entries are stored server-side as `[Hidden from Player]` notes.
  - `plot-summary` entries are hidden from client chat history and flagged `excludeFromBaseContextHistory`; old summaries remain in save/chat logs but are excluded from normal prompt history assembly. The latest summary is injected separately into base-context as `<plotSummary>...</plotSummary>` immediately before `<recentStoryHistory>`.
  - `plot-expander` entries are hidden from client chat history and flagged `excludeFromBaseContextHistory`; old entries remain in save/chat logs but are excluded from normal prompt history assembly. The latest entry is injected separately into base-context as `<plotExpander>...</plotExpander>` immediately after `<plotSummary>`.
  - Base-context now appends compact current conditions at the end of the prompt (`time` in 24-hour `HH:MM`, plus `weather` name/description and `lightLevel` description only when the current location supports local weather). Region weather definitions are parsed from region-generation XML and persisted on `Region`.
  - Post-turn NPC memory/disposition processing now emits dedicated `event-summary` entries (`ðŸ“‹ Events â€“ Disposition Check (...)`) when disposition deltas are applied, instead of relying on an existing event bundle from main event checks.
  - The rest of turn handling still includes attack damage application, quest confirmations, random event seeds, NPC corpse cleanup, and structured debug info.
  - Attack checks now parse `<damageEffectiveness>` (1-5) and apply a multiplier only when pre-effectiveness damage is above zero: `1 => x0`, `2 => x0.5` (rounded up with `ceil`), `3 => x1`, `4 => x2`, `5 => x3`.
  - Random events are checked independently of NPC turn processing (forced-event actions still suppress random events), and rolls are scaled by `random_event_frequency_multiplier`.
  - Random event narrative prompt logs are written through `LLMClient.logPrompt` (`metadataLabel: random_event`) rather than a custom file writer.
  - Prompt logging is standardized through `LLMClient.logPrompt` for prompt flows that previously wrote custom `logs/*.log` files, including `summarize_batch`, `disposition_check`, `next_npc_list`, `npc_memories`, `setting_autofill`, `region_stub_locations`, `inventory_generation_*`, `npc_generation_single`, `location_npc_generation`, `region_npc_generation`, `location_generation`, `region_generation`, `existing_region_exit`, and `image_prompt_generation`.
  - On `<travelProse>` turns, split origin/destination event checks can apply `item_appear` and `scenery_appear` outcomes even after movement has been marked processed.
  - Event-check prompt rendering now passes `actionText` explicitly and only includes `<playerAction>` inside `<textToCheck>` when the originating player action resolved as successful/trivial.
  - Travel actions are guarded by a per-player non-blocking move lock; concurrent move attempts for the same player return `409` instead of racing.
  - `/api/chat` and `/api/player/move` now also return `409` when the player has pending level-up ability picks; payloads include `pendingAbilitySelection` so the UI can force-open the draft modal. Pending checks are skipped when no game is loaded (`Globals.gameLoaded === false`).
  - Event-driven travel movement resolution now uses authoritative `gameLocations` lookups only (no `Location` index fallback), and move paths run strict post-move location/region/exit integrity assertions.
  - Additional endpoints cover quest confirmations, chat history mutations, player CRUD (attributes, health, needs, party, skills, portraits), NPC CRUD/teleport/equipment/dispositions/memories/goals, location/region CRUD and generation (including stub expansion, exits, maps), crafting, thing/item operations (create, give/drop/teleport/delete/image), settings management (create/save/load/apply), save/load/new-game flows, slash commands, config test endpoints, and image job APIs (request/async generation/job status/metadata listing).
  - `POST /api/factions` now runs a dedicated inbound-relationship prompt when existing factions are present, then writes generated relations from each existing faction toward the newly created faction.
  - Save-load reconciliation now enforces party/location invariants for the current player on load: party members are removed from all location `npcIds` lists and their explicit `currentLocation` is cleared.
  - Save-load reconciliation also repairs stale faction references before selecting the current player: invalid faction ids are cleared from player faction ownership/standings, location and region controlling-faction fields, pending region-stub controlling-faction fields, and faction relation edges that reference missing or self ids.
  - Save-load flow proactively resolves player level-up draft pending state after hydration (`resolvePlayerAbilitySelectionState(..., { ensureOptionsForNext: false })`) without generating options yet; option generation occurs when the client explicitly requests it through the ability-selection endpoint.
  - Save metadata now tracks `npcAliasesGenerated` (boolean). On load, metadata is normalized; the chat UI prompts for legacy saves with the flag missing/false and can trigger bulk `/api/npcs/generate-aliases` processing (20 NPCs per alias prompt batch), which marks/persists the flag.
  - Uses helpers like `runAutosaveIfEnabled`, `generateRandomEventSeeds/ensureRandomEventSeedsForArea`, `renderCraftOutcomeForDegree`, and numerous validation branches to reject unsupported operations with explicit errors/status codes.

- Events.js
  - Static orchestrator class with `initialize(deps)` to wire dependencies (Location/Region lookup/generation, prompt env, XML parsing, exit connections, image generation, quest confirmations, currency labels, etc.) and configure timeouts/status durations. Maintains tracking sets to dedupe item/NPC/location changes in a turn.
  - `runEventChecks` renders an event-check prompt (built from EVENT_PROMPT_ORDER), accepts optional `actionText` context for `<playerAction>`, calls `LLMClient.chatCompletion` with a required `<final>` regex (so missing blocks retry), parses the numbered answers from the `<final>` block into structured entries, and optionally suppresses environmental effects. It aggregates raw text into HTML, tracks follow-up queues, and can recursively analyze reward prose. Combined group answers are parsed as final block text (no extra `<final>` wrapper).
  - Before applying outcomes, Events ensures referenced NPCs exist (excluding death/incapacitation and defeated-enemy mentions), so handlers can resolve actors reliably; ensured NPCs are title-cased when their source name contains no capital letters.
  - Parsers/aggregators/handlers convert LLM responses into world mutations: new exits/movement, location alterations/regeneration, currency changes, item animation/alter/consume/drop/harvest/appearance, NPC arrival/departure/spawn, party changes, dispositions, status effects, environmental damage/healing, need bar changes, XP and quest awards/completions, deaths/incapacitation, triggered abilities, and random event seeding. Handlers rely on injected helpers to create/locate entities, ensure exits, queue assets, and generate images when needed.
  - Provides quest-specific checks, status effect helpers (`makeStatusEffect`, default/major durations), placeholder item creation for alterations, and utility methods for accessing current player/config/deps through `this._deps`.

- LLMClient.js
  - Axios-based chat wrapper pulling defaults from `Globals.config.ai`; enforces explicit config (endpoint/apiKey/model) and normalizes `/chat/completions` endpoints. Controls concurrency with semaphores keyed by apiKey+model (`getMaxConcurrent`), supports per-call overrides plus metadata-label `ai_model_overrides`, and re-resolves effective settings on each retry attempt.
  - Supports `ai.custom_args` injection into request payloads and deep per-key `custom_args` merging through `ai_model_overrides` profiles (with `null` deleting inherited keys and reserved core payload keys rejected), plus `ai.headers` request-header injection with per-key `ai_model_overrides` header merging (and `null` key deletion support).
  - Supports streaming with progress tracking/broadcast (`prompt_progress` via `Globals.realtimeHub`), timeout scaling, retry handling with optional waits, and on-response hooks. Seeds requests unless suppressed, resolves temperature/max_tokens, and merges extra payload/headers.
  - Stream processing now assembles `delta.tool_calls` chunks into complete tool-call objects, validates JSON arguments, and exposes normalized `choices[0].message.tool_calls` to callers for both stream and non-stream responses.
  - Strips `<think>` blocks from responses after optionally logging; validates XML and required tags when requested, writes errors and prompts to `logs/` via `writeLogFile`/`logPrompt`, and dumps debug payloads when enabled. Exposes helpers for base timeout resolution and progress rendering (interactive terminal friendly but guarded by TTY checks).
