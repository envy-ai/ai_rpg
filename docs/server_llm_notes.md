Server & LLM Notes

- server.js
  - Bootstraps config (default + override yaml + --port), sets Globals.baseDir/config, and initializes Express + HTTP + RealtimeHub + ModLoader static serving. Maintains in-memory maps for players, things, skills, locations, exits, regions, pending stubs/images, and in-flight generations. Provides chat utilities (`normalizeChatEntry`, `pushChatEntry`, `scrubGeneratedBrackets`), location/region/thing helpers, save/load wiring (exposed via module.exports), and exposes many of these via `apiScope`.
  - Builds `promptEnv`/`viewsEnv` with Nunjucks, loads templates, and defines `prepareBasePromptContext` (builds base prompt context, triggers NPC memory selection jobs). Attaches `Globals.getBasePromptContext` and other helpers (e.g., plausibility parsing, attack resolution, status ticking).
  - Recent history keeps `event-summary` entries intact (scrubber can skip event stripping via `scrub_events`); if their content is empty, `<recentStoryHistory>` renders them from `summaryItems`. Absent-character suffixes union `locationId` and `metadata.traveledToLocationId` when present.
  - Base prompt context now includes a `<factions>` block for LLM generation; location/region generators and NPC generators expect full faction names (or "None") and the server resolves those names to ids.
  - Manages image generation backends (ComfyUI/NanoGPT/OpenAI), queuing (`createImageJob`, `processJobQueue`, job maps/sets, `generateImageId`), and exposes job snapshots. Handles realtime attach, slash commands, mod loading, and kicks off default player creation + server start.
  - Initializes `Events` with dependencies (Location/Region accessors, generation functions, exit connection helpers, image generators, quest confirmation, etc.) and then registers routes via api.js using the populated `apiScope`.

- api.js
  - Exports `registerApiRoutes(scope)`; validates scope (must include Express app plus numerous helpers) and optionally installs an axios AI debug interceptor. Uses `with (scope)` to share state. Utility helpers inside include stream emitters for realtime (`realtimeHub`), autosave pruning, XML helpers for crafting/random events, and deletion helpers for NPCs/things.
  - `/api/chat` is the main turn handler: applies status effect need deltas, optional travel metadata, autosave (autosaves skip the newest chat entry if it matches the latest autosave entry id), plausibility/attack checks (attack rolls add level bonuses: ceil(attacker/2) to attack skill + damage attribute; floor(defender/2) to evade/deflect), builds prompts via `prepareBasePromptContext` + `promptEnv`, calls `LLMClient.chatCompletion`, logs prompts, and streams status back to the client. It records chat history, injects NPC/location memories, may trigger Events.runEventChecks, attack damage application, quest confirmations, random event seeds, NPC corpse cleanup, and emits structured debug info. Random events are checked independently of NPC turn processing (forced-event actions still suppress random events).
  - Additional endpoints cover quest confirmations, chat history mutations, player CRUD (attributes, health, needs, party, skills, portraits), NPC CRUD/teleport/equipment/dispositions/memories/goals, location/region CRUD and generation (including stub expansion, exits, maps), crafting, thing/item operations (create, give/drop/teleport/delete/image), settings management (create/save/load/apply), save/load/new-game flows, slash commands, config test endpoints, and image job APIs (request/async generation/job status/metadata listing).
  - Uses helpers like `runAutosaveIfEnabled`, `generateRandomEventSeeds/ensureRandomEventSeedsForArea`, `renderCraftOutcomeForDegree`, and numerous validation branches to reject unsupported operations with explicit errors/status codes.

- Events.js
  - Static orchestrator class with `initialize(deps)` to wire dependencies (Location/Region lookup/generation, prompt env, XML parsing, exit connections, image generation, quest confirmations, currency labels, etc.) and configure timeouts/status durations. Maintains tracking sets to dedupe item/NPC/location changes in a turn.
  - `runEventChecks` renders an event-check prompt (built from EVENT_PROMPT_ORDER), calls `LLMClient.chatCompletion` with a required `<final>` regex (so missing blocks retry), parses the numbered answers from the `<final>` block into structured entries, and optionally suppresses environmental effects. It aggregates raw text into HTML, tracks follow-up queues, and can recursively analyze reward prose. Combined group answers are parsed as final block text (no extra `<final>` wrapper).
  - Before applying outcomes, Events ensures referenced NPCs exist (excluding death/incapacitation and defeated-enemy mentions), so handlers can resolve actors reliably; ensured NPCs are title-cased when their source name contains no capital letters.
  - Parsers/aggregators/handlers convert LLM responses into world mutations: new exits/movement, location alterations/regeneration, currency changes, item animation/alter/consume/drop/harvest/appearance, NPC arrival/departure/spawn, party changes, dispositions, status effects, environmental damage/healing, need bar changes, XP and quest awards/completions, deaths/incapacitation, triggered abilities, and random event seeding. Handlers rely on injected helpers to create/locate entities, ensure exits, queue assets, and generate images when needed.
  - Provides quest-specific checks, status effect helpers (`makeStatusEffect`, default/major durations), placeholder item creation for alterations, and utility methods for accessing current player/config/deps through `this._deps`.

- LLMClient.js
  - Axios-based chat wrapper pulling defaults from `Globals.config.ai`; enforces explicit config (endpoint/apiKey/model) and normalizes `/chat/completions` endpoints. Controls concurrency with semaphores keyed by apiKey+model (`getMaxConcurrent`), supports per-call overrides plus prompt_ai_overrides by metadataLabel.
  - Supports streaming with progress tracking/broadcast (`prompt_progress` via `Globals.realtimeHub`), timeout scaling, retry handling with optional waits, and on-response hooks. Seeds requests unless suppressed, resolves temperature/max_tokens, and merges extra payload/headers.
  - Strips `<think>` blocks from responses after optionally logging; validates XML and required tags when requested, writes errors and prompts to `logs/` via `writeLogFile`/`logPrompt`, and dumps debug payloads when enabled. Exposes helpers for base timeout resolution and progress rendering (interactive terminal friendly but guarded by TTY checks).
