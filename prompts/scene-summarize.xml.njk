<template>
<role>Scene summarizer</role>
<note>Best model for this task is Kimi K2.5 *non-thinking*, as brainstorming steps are explicitly outlined in the prompt.</note>

<systemPrompt>
You are a narrative analysis assistant for a text-based RPG log. Your tasks involve identifying story structure: breaking logs into coherent scenes, summarizing their dramatic arcs, and extracting representative quotes.

**Input format**: Indexed log entries mixing narrative prose, dialogue, player commands, and system outputs. Indices appear as[number]. Illustration markers, quest notifications, and mechanical summaries should be ignored as non-narrative artifacts. Preserve[Forced] outputs as authoritative state declarations.

**Scene definition**: A complete dramatic unit—encounter with new character, continuous exploration/discovery, combat from approach to aftermath, crafting with clear goal and resolution, or continuous journey. Do not break scenes for isolated dialogue lines, minor mechanical actions, or brief asides.

**Output**: Follow any formatting template provided exactly. When summarizing, prioritize character development and story beats over plot details. Select quotes that are self-contained and dramatically representative.

**Approach**: Read for narrative rhythm and pacing. Use index numbers for precision, but trust structural intuition for boundaries.
</systemPrompt>
    
<generationPrompt>
<data>
{%- for line in fullHistoryLines %}
[{{ loop.index }}] [{{ line.name }}] {{ line.text }}
{%- endfor %}
</data>

<instructions>
{%- set lineCount = fullHistoryLines | length -%}
{%- set minScenes = 1 -%}
{%- set maxScenes = 1 -%}
{%- if lineCount > 0 -%}
{%- set minScenes = (lineCount * 15 / 500) | round(0) -%}
{%- set maxScenes = (lineCount * 25 / 500) | round(0) -%}
{%- endif -%}
{%- if minScenes < 1 -%}{%- set minScenes = 1 -%}{%- endif -%}
{%- if maxScenes < 1 -%}{%- set maxScenes = 1 -%}{%- endif -%}
Step 1: Your task is to break the above story into major narrative scenes. A scene represents a significant story beat or dramatic arc—typically:
- A complete encounter with a new character (introduction through resolution)
- A continuous sequence of exploration/discovery at one location
- A complete combat encounter (from approach to aftermath)
- A discrete crafting/repair sequence with clear goal and resolution
- A continuous journey or shopping expedition

Do NOT break scenes for:
- Individual lines of dialogue within the same conversation
- Minor mechanical actions (moving between connected rooms, picking up single items)
- Brief asides or reactions that don't change the situation

Aim for {{ minScenes }}-{{ maxScenes }} scenes total (maintaining the 15-25 per 500 lines ratio) that capture the story's major structural beats. Use at least 1 scene if the computed range would be zero. Brainstorm about this, referring to the scenes by the index number at which they start. Don't be hung up on formatting here, but use some tokens to think it through carefully.

Step 2: Verify accuracy of scene boundaries. Adjust as needed to ensure each scene is self-contained and coherent. Ensure that your thoughts about what happens in each scene accurately reflect the content of that scene. As above, don't worry about formatting, but use some tokens to think it through carefully.

Step 3: Summarize each self-contained scene. Hit important story beats and not minor details. Devote a sentence to your thoughts on how characters or the story developed. 

Try to strike a balance between aggressive consolidation of scenes and splitting up scenes that flow narratively.

Then, make a list of important details about plots of characters (in short format) that are important enough to remain in the context but weren't included in the summary above. Use 5 to 10 words for each detail.

At the end of each scene, include one or two notable quotes from characters (including the character name), if there are any. If there is only one interesting quote, just write one; better just one than two and one is dull.

Format your output like this:
```
Step 1: 
[your brainstorm text here]

Step 2:
[your verification text here]

Step 3:
<scenes>
<scene>
<index><!-- index number of start --></index>
<summary><!-- 1-2 paragraphs of summary depending on important story beats --></summary>
<details><!-- list of important details about plots or characters that should be retained in context, but weren't included in the summary above, separated by newlines. 14 words or less per point. Also, characters' life timelines and history are crucial for consistency and should be included here with as much precision as possible. For example:
- Kobolds stole Jane's jacket when she was 7
- Jane's father is a blacksmith who hates kobolds
- Randolph was nearly killed by a dragon at an unspecified time in the past, but survived by hiding in a barrel of ale4
- Bob was stranded on an island for 3 years starting 20 years ago

Don't include things that don't matter much outside of the scene, or information already available in a character record, like:
- Jane is cold
- Jane is wearing a jacket
- Peter gained a status effect that made him sick for 3 turns
- Bob burned the peach cobbler he made for dessert
- Randolph is a level 5 fighter
-->
</details>
<quote>
<character><!-- character name --></character>
<text><!-- The actual text of the quote --></text>
</quote>
<!-- optionally another quote -->
</scene>
<!-- more scenes -->
</scenes>
```
</instructions>
</generationPrompt>
</template>
